<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Importa√ß√£o | Tributa√ß√£o - NCM e Impostos</title>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Ubuntu', sans-serif;
            transition: background 0.3s ease;
            min-height: 100vh;
            padding: 20px;
        }

        /* Skins */
        body.skin-1 {
            background: #0F2027;
            background: -webkit-linear-gradient(to right, #2C5364, #203A43, #0F2027);
            background: linear-gradient(to right, #2C5364, #203A43, #0F2027);
        }

        body.skin-2 {
            background: #3E5151;
            background: -webkit-linear-gradient(to right, #DECBA4, #3E5151);
            background: linear-gradient(to right, #DECBA4, #3E5151);
        }

        body.skin-3 {
            background: #34e89e;
            background: -webkit-linear-gradient(to right, #0f3443, #34e89e);
            background: linear-gradient(to right, #0f3443, #34e89e);
        }

        body.skin-4 {
            background: #F3904F;
            background: -webkit-linear-gradient(to right, #3B4371, #F3904F);
            background: linear-gradient(to right, #3B4371, #F3904F);
        }

        body.skin-5 {
            background: #ffd89b;
            background: -webkit-linear-gradient(to right, #19547b, #ffd89b);
            background: linear-gradient(to right, #19547b, #ffd89b);
        }

        body.skin-6 {
            background: #4B79A1;
            background: -webkit-linear-gradient(to right, #283E51, #4B79A1);
            background: linear-gradient(to right, #283E51, #4B79A1);
        }

        body.skin-7 {
            background: #403A3E;
            background: -webkit-linear-gradient(to right, #BE5869, #403A3E);
            background: linear-gradient(to right, #BE5869, #403A3E);
        }

        .data-download-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 45px;
            height: 45px;
            font-size: 20px;
            text-decoration: none; /* Para remover sublinhado do link */
        }

        .data-download-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }

.container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

	        .title-glass-container {
	            background: rgba(255, 255, 255, 0.15);
	            backdrop-filter: blur(10px);
	            border: 1px solid rgba(255, 255, 255, 0.3);
	            border-radius: 15px;
	            padding: 15px 25px;
	            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
	            margin-right: 20px; /* Para separar do seletor de skins */
	        }

	        .title {
	            color: white;
	            font-size: 28px;
	            font-weight: 700;
	            margin: 0; /* Remove margem padr√£o do h1 */
	        }

		        .skin-selector {
		            position: relative;
		            display: flex; /* Alterado para flex */
                    align-items: center; /* Alinha verticalmente */
                    gap: 10px; /* Espa√ßamento entre os itens */
		        }

        .skin-dropdown-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 45px;
            height: 45px;
            font-size: 20px;
        }

        .skin-dropdown-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: rotate(90deg);
        }

        /* Tooltip para o bot√£o de download */
        .data-download-btn-container {
            position: relative;
            display: inline-block;
        }

        .data-download-btn-container .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* Posi√ß√£o acima do bot√£o */
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .data-download-btn-container .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }

        .data-download-btn-container:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

		        .skin-dropdown-content {
	            display: none;
	            position: absolute;
	            right: 0;
	            background: rgba(0, 0, 0, 0.8);
	            min-width: 200px;
	            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
	            z-index: 1;
	            border-radius: 6px;
	            padding: 10px;
	            margin-top: 5px;
	            flex-direction: column;
	            gap: 5px;
	        }

	        .skin-dropdown-content.show {
	            display: flex;
	        }

	        .skin-btn {
            width: 40px;
            height: 40px;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            background: rgba(255, 255, 255, 0.1);
        }

        .skin-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        .skin-btn.active {
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
            border-color: #fff;
        }

	        .skin-1-btn { background: linear-gradient(to right, #2C5364, #203A43, #0F2027); }
	        .skin-2-btn { background: linear-gradient(to right, #DECBA4, #3E5151); }
	        .skin-3-btn { background: linear-gradient(to right, #0f3443, #34e89e); }
	        .skin-4-btn { background: linear-gradient(to right, #3B4371, #F3904F); }
	        .skin-5-btn { background: linear-gradient(to right, #19547b, #ffd89b); }
	        .skin-6-btn { background: linear-gradient(to right, #283E51, #4B79A1); }
		        .skin-7-btn { background: linear-gradient(to right, #BE5869, #403A3E); }

        /* Novos Skins */
        body.skin-8 {
            background: #A1FFCE;
            background: -webkit-linear-gradient(to right, #FAFFD1, #A1FFCE);
            background: linear-gradient(to right, #FAFFD1, #A1FFCE);
        }
        .skin-8-btn { background: linear-gradient(to right, #FAFFD1, #A1FFCE); }

        body.skin-9 {
            background: #ffd89b;
            background: -webkit-linear-gradient(to right, #19547b, #ffd89b);
            background: linear-gradient(to right, #19547b, #ffd89b);
        }
        .skin-9-btn { background: linear-gradient(to right, #19547b, #ffd89b); }

        body.skin-10 {
            background: #F1F2B5;
            background: -webkit-linear-gradient(to right, #135058, #F1F2B5);
            background: linear-gradient(to right, #135058, #F1F2B5);
        }
        .skin-10-btn { background: linear-gradient(to right, #135058, #F1F2B5); }

        body.skin-11 {
            background: #1F1C2C;
            background: -webkit-linear-gradient(to right, #928DAB, #1F1C2C);
            background: linear-gradient(to right, #928DAB, #1F1C2C);
        }
        .skin-11-btn { background: linear-gradient(to right, #928DAB, #1F1C2C); }

	        /* Fechar o dropdown se clicar fora */
	        window.onclick = function(event) {
	            if (!event.target.matches('.skin-dropdown-btn') && !event.target.closest('.skin-dropdown-btn')) {
	                const dropdowns = document.getElementsByClassName("skin-dropdown-content");
	                for (let i = 0; i < dropdowns.length; i++) {
	                    const openDropdown = dropdowns[i];
	                    if (openDropdown.classList.contains('show')) {
	                        openDropdown.classList.remove('show');
	                    }
	                }
	            }
	        }

        .content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            color: white;
            transition: all 0.3s ease;
        }

        .card:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
        }

        .toggle-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }

        .toggle-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .card-content {
            display: none;
            animation: slideDown 0.3s ease;
        }

        .card-content.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-family: 'Ubuntu', sans-serif;
            transition: all 0.2s;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.4), inset 0 0 10px rgba(255, 255, 255, 0.1);
        }

        .form-group select option {
            background: #333;
            color: white;
        }

        .form-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        @media (max-width: 1024px) {
            .form-grid-3 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .form-grid-3 {
                grid-template-columns: 1fr;
            }
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-family: 'Ubuntu', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .btn-primary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-primary:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .btn-info {
            background: #2196F3;
            color: white;
        }

	        .btn-info:hover {
	            background: #0b7dda;
	        }

	        /* Estilos para o bot√£o de escolha de arquivo */
	        .file-input-wrapper {
	            position: relative;
	            overflow: hidden;
	            display: inline-block;
	            width: 100%;
	        }

	        .file-input-wrapper input[type="file"] {
	            font-size: 100px;
	            position: absolute;
	            left: 0;
	            top: 0;
	            opacity: 0;
	            cursor: pointer;
	        }

	        .custom-file-upload {
	            border: 1px solid rgba(255, 255, 255, 0.3);
	            display: block; /* Alterado para block para ocupar a largura total */
	            padding: 10px 12px;
	            cursor: pointer;
	            border-radius: 6px;
	            background: rgba(255, 255, 255, 0.1);
	            color: white;
	            font-weight: 500;
	            transition: all 0.2s;
	            width: 100%;
	            text-align: left;
	            white-space: nowrap;
	            overflow: hidden;
	            text-overflow: ellipsis;
	        }

        .custom-file-upload:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .file-select-btn {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 10px 20px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .file-select-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
        }

        .file-input-container {
            position: relative;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s;
        }

        .file-input-container:hover {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }

        .file-input-container input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .file-name-display {
            margin-top: 15px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-style: italic;
        }

        .ncm-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ncm-item-content {
            flex: 1;
        }

        .ncm-item-btn {
            padding: 5px 10px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .ncm-item-btn:hover {
            background: #da190b;
        }

        .data-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            color: white;
            margin-top: 20px;
        }

        .data-section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .data-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid rgba(255, 255, 255, 0.3);
        }

        .data-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .data-item-title {
            font-weight: 600;
        }

        .data-item-btn {
            padding: 5px 10px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .data-item-btn:hover {
            background: #da190b;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

	        .action-buttons .btn {
	            flex: 1;
	            min-width: 150px;
	        }
	
	        .ncm-inconsistency-grid {
	            display: grid;
	            grid-template-columns: 1fr 1fr;
	            gap: 20px;
	            margin-top: 20px;
	        }
	
	        @media (max-width: 768px) {
	            .ncm-inconsistency-grid {
	                grid-template-columns: 1fr;
	            }
	        }

        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .skin-selector {
                width: 100%;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons .btn {
                min-width: auto;
            }
        }

        /* Spinner com Glass Effect */
        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner-overlay.active {
            display: flex;
        }

        .spinner-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner-text {
            color: white;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .spinner-progress {
            width: 200px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin: 0 auto;
        }

        .spinner-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.8));
            border-radius: 3px;
            animation: progressBar 2s ease-in-out infinite;
        }

        @keyframes progressBar {
            0% { width: 0%; }
            50% { width: 100%; }
            100% { width: 0%; }
        }


        /* Modal de Mapeamento */
        .mapping-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .mapping-modal.active {
            display: flex;
        }

        .mapping-modal-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 30px;
            color: white;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .mapping-modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .mapping-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 3px solid rgba(255, 255, 255, 0.3);
        }

        .mapping-item-label {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .mapping-item select {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-family: 'Ubuntu', sans-serif;
        }

        .mapping-item select:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .mapping-item select option {
            background: #333;
            color: white;
        }

        .mapping-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .mapping-buttons .btn {
            flex: 1;
        }

    </style>
</head>
<body class="skin-1">
    <div class="container">
	        <div class="header">
	            <div class="title-glass-container">
	                <h1 class="title">Sistema de Importa√ß√£o | Tributa√ß√£o - NCM e Impostos</h1>
            </div>
            <div class="skin-selector">
                <div class="data-download-btn-container">
                    <a href="https://drive.usercontent.google.com/download?id=1E8yGgS-coCdD0l7bZqeh3IlP45fXn6Jd&export=download&authuser=0" class="data-download-btn" download="ConjuntoDeDados.zip" title="Conjunto de dados">
                        <!-- √çcone de maleta (briefcase) - Usando um √≠cone Unicode ou um caractere similar -->
                        <span>&#x1F4C1;</span>
                    </a>
                    <span class="tooltiptext">Conjunto de dados</span>
                </div>
                <button class="skin-dropdown-btn" onclick="toggleSkinDropdown()" title="Selecionar Skin">
                    <span>&#9881;</span>
                </button>
	                <div class="skin-dropdown-content" id="skinDropdown">
	                    <button class="skin-btn skin-1-btn" onclick="changeSkin('skin-1', event)" title="Skin 1"></button>
	                    <button class="skin-btn skin-2-btn" onclick="changeSkin('skin-2', event)" title="Skin 2"></button>
	                    <button class="skin-btn skin-3-btn" onclick="changeSkin('skin-3', event)" title="Skin 3"></button>
	                    <button class="skin-btn skin-4-btn" onclick="changeSkin('skin-4', event)" title="Skin 4"></button>
	                    <button class="skin-btn skin-5-btn" onclick="changeSkin('skin-5', event)" title="Skin 5"></button>
	                    <button class="skin-btn skin-6-btn" onclick="changeSkin('skin-6', event)" title="Skin 6"></button>
		                    <button class="skin-btn skin-7-btn" onclick="changeSkin('skin-7', event)" title="Skin 7"></button>
		                    <button class="skin-btn skin-8-btn" onclick="changeSkin('skin-8', event)" title="Skin 8"></button>
		                    <button class="skin-btn skin-9-btn" onclick="changeSkin('skin-9', event)" title="Skin 9"></button>
		                    <button class="skin-btn skin-10-btn" onclick="changeSkin('skin-10', event)" title="Skin 10"></button>
		                    <button class="skin-btn skin-11-btn" onclick="changeSkin('skin-11', event)" title="Skin 11"></button>
	                </div>
	            </div>
        </div>

        <div class="content">
            <!-- CARD: DADOS INICIAIS -->
            <div class="card">
                <div class="card-header" onclick="toggleCard(this)">
                    <h2 class="card-title">Informe a data a partir da qual deve vigorar esta regra</h2>
                    <button class="toggle-btn">+</button>
                </div>
                <div class="card-content">
                    <div class="form-group" style="display: none;">
                        <label>Tipo</label>
                        <input type="text" value="Vig√™ncia" readonly>
                    </div>
                    <div class="form-group">
                        <label>Vig√™ncia</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="date" id="dataInicial" style="flex-grow: 1;">
                            <button class="btn btn-primary" onclick="copyPreviousDate()" title="Copiar data da √∫ltima regra criada" style="flex-shrink: 0; padding: 0 10px;">
                                <span style="font-size: 1.2em;">&#x21BA;</span>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Descri√ß√£o da vig√™ncia</label>
                        <input type="text" id="descricaoInicial" placeholder="Vigente mm/aaaa">
                    </div>
                </div>
            </div>

            <!-- CARD: TRIBUTA√á√ÉO -->
            <div class="card">
                <div class="card-header" onclick="toggleCard(this)">
                    <h2 class="card-title">Tributa√ß√£o</h2>
                    <button class="toggle-btn">+</button>
                </div>
                <div class="card-content">
                    <div class="form-group" style="display: none;">
                        <label>Tipo</label>
                        <input type="text" value="Item" readonly>
                    </div>
                    <div class="form-group">
                        <label>Descri√ß√£o da tributa√ß√£o Ex: Monof√°sicos</label>
                        <input type="text" id="descricaoTributacao" placeholder="Digite a descri√ß√£o">
                    </div>
                </div>
            </div>

            <!-- CARD: IMPORTA ARQUIVO | NCM -->
            <div class="card">
                <div class="card-header" onclick="toggleCard(this)">
                    <h2 class="card-title">Importar Arquivo</h2>
                    <button class="toggle-btn">+</button>
                </div>
                <div class="card-content">
                    <div class="form-group">
                        <label>Importar Arquivo Excel (NCM)</label>
                        <div class="file-input-container">
                            <input type="file" id="fileImport" accept=".xlsx,.xls,.csv" onchange="updateFileName(this)">
                            <div class="file-select-btn" onclick="document.getElementById('fileImport').click()">
                                üìÅ Selecionar arquivo
                            </div>
                            <div class="file-name-display" id="fileLabel">Nenhum arquivo selecionado</div>
                        </div>
                    </div>
                    <button class="btn btn-info" onclick="importFile()">Importar</button>
                </div>
            </div>

            <!-- CARD: CONFIGURA√á√ïES -->
            <div class="card">
                <div class="card-header" onclick="toggleCard(this)">
                    <h2 class="card-title">Configura√ß√µes</h2>
                    <button class="toggle-btn">+</button>
                </div>
                <div class="card-content">
                    <div class="form-group" style="display: none;">
                        <label>Tipo</label>
                        <input type="text" value="Impostos" readonly>
                    </div>
                    <div class="form-grid-3">
                        <div class="form-group">
                            <label>Tipo Tributa√ß√£o</label>
                            <select id="tipoTributacao">
                                <option value="">Selecione...</option>
                                <option value="N">N - N√£o cumulativo</option>
                                <option value="C">C - Cumulativo</option>
                                <option value="T">T - Substitui√ß√£o tribut√°ria</option>
                                <option value="S">S - Sem incid√™ncia</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>CST PIS e COFINS Entradas</label>
                            <input type="text" id="cstPisCofinEntrada" placeholder="Ex: 70">
                        </div>
                        <div class="form-group">
                            <label>V√≠nculo de Cr√©dito</label>
                            <input type="text" id="vinculoCredito" placeholder="Ex: 99">
                        </div>
                        <div class="form-group">
                            <label>Base de Cr√©dito</label>
                            <input type="text" id="baseCredito" placeholder="Ex: 1">
                        </div>
                        <div class="form-group">
                            <label>Al√≠quota PIS Entrada</label>
                            <input type="text" id="aliquotaPisEntrada" placeholder="Ex: 0">
                        </div>
                        <div class="form-group">
                            <label>Al√≠quota COFINS Entrada</label>
                            <input type="text" id="aliquotaCofinsEntrada" placeholder="Ex: 0">
                        </div>
                        <div class="form-group">
                            <label>CST PIS e COFINS Sa√≠da</label>
                            <input type="text" id="cstPisCofinSaida" placeholder="Ex: 1">
                        </div>
                        <div class="form-group">
                            <label>Natureza da Receita</label>
                            <input type="text" id="naturezaReceita" placeholder="Ex: 999">
                        </div>
                        <div class="form-group">
                            <label>Al√≠quota PIS Sa√≠da</label>
                            <input type="text" id="aliquotaPisSaida" placeholder="Ex: 0,65">
                        </div>
                        <div class="form-group">
                            <label>Al√≠quota COFINS Sa√≠da</label>
                            <input type="text" id="aliquotaCofinssSaida" placeholder="Ex: 3">
                        </div>
                        <div class="form-group">
                            <label>CST ICMS Entrada</label>
                            <input type="text" id="cstIcmsEntrada" placeholder="">
                        </div>
                        <div class="form-group">
                            <label>CST ICMS Sa√≠da</label>
                            <input type="text" id="cstIcmsSaida" placeholder="">
                        </div>
                        <div class="form-group">
                            <label>Al√≠quota ICMS</label>
                            <input type="text" id="aliquotaIcms" placeholder="">
                        </div>
                        <div class="form-group">
                            <label>CST IPI Entrada</label>
                            <input type="text" id="cstIpiEntrada" placeholder="">
                        </div>
                        <div class="form-group">
                            <label>CST IPI Sa√≠da</label>
                            <input type="text" id="cstIpiSaida" placeholder="">
                        </div>
                        <div class="form-group">
                            <label>Al√≠quota de IPI</label>
                            <input type="text" id="aliquotaIpi" placeholder="">
                        </div>
                        <div class="form-group">
                            <label>Produto sujeito a PIS e COFINS</label>
                            <select id="produtoSujeitoPisCofins">
                                <option value="">Selecione...</option>
                                <option value="S">S - Sim</option>
                                <option value="N">N - N√£o</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tipo de Tributa√ß√£o PIS/COFINS</label>
                            <select id="tipoTributacaoPisCofins">
                                <option value="">Selecione...</option>
                                <option value="1">1 - Monof√°sico</option>
                                <option value="2">2 - Subst Tribut√°ria</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CARD: NCM -->
            <div class="card">
                <div class="card-header" onclick="toggleCard(this)">
                    <h2 class="card-title">NCM's</h2>
                    <button class="toggle-btn">+</button>
                </div>
                <div class="card-content">
                    <div class="form-group" style="display: none;">
                        <label>Tipo</label>
                        <input type="text" value="NCM" readonly>
                    </div>
                    <div class="form-group">
                        <label>C√≥digo NCM - sem pontua√ß√£o</label>
                        <input type="text" id="codigoNcm" placeholder="Ex: 27101159">
                    </div>
                    <div class="form-group">
                        <label>C√≥digo CEST - sem pontua√ß√£o</label>
                        <input type="text" id="codigoCest" placeholder="">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="addNcm()">Incluir NCM</button>
                    </div>
         	                <div id="ncmList" style="margin-top: 15px;"></div>
	            </div>
	        </div>
	
	        <!-- NOVOS QUADROS DE INCONSIST√äNCIAS -->
	        <div class="ncm-inconsistency-grid">
	            <!-- NCM/CEST INCONSISTENTES -->
	            <div class="card">
	                <div class="card-header" onclick="toggleCard(this)">
	                    <h2 class="card-title">NCM/CEST Inconsistentes (<span id="inconsistentCount">0</span>)</h2>
	                    <button class="toggle-btn">+</button>
	                </div>
	                <div class="card-content" id="inconsistentNcmList" style="display: none;">
	                    <!-- Conte√∫do ser√° preenchido por JavaScript -->
	                </div>
	            </div>
	
	            <!-- NCM/CEST REPETIDOS -->
	            <div class="card">
	                <div class="card-header" onclick="toggleCard(this)">
	                    <h2 class="card-title">NCM/CEST Repetidos (<span id="repeatedCount">0</span>)</h2>
	                    <button class="toggle-btn">+</button>
	                </div>
	                <div class="card-content" id="repeatedNcmList" style="display: none;">
	                    <!-- Conte√∫do ser√° preenchido por JavaScript -->
	                </div>
	            </div>
	        </div>
	
		        <!-- DADOS INSERIDOS -->
        <div class="data-section">
            <div class="card-header" onclick="toggleDataSection(this)">
                <h2 class="data-section-title">Dados Processados</h2>
                <button class="toggle-btn">+</button>
            </div>
            <div id="dataContent" class="card-content" style="display: none;">
                <div id="dataList"></div>
            </div>
        </div>

        <!-- ACTION BUTTONS -->
        <div class="action-buttons">
            <button class="btn btn-success" onclick="addNewData()">Criar Regra</button>
            <button class="btn btn-info" onclick="generateFile()">Gerar TXT</button>
        </div>
    </div>

	    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
	    <script>
	        let allData = [];
	        let lastDataInicial = '';
	        let initialDescriptionLocked = false;
	
        function updateFileName(input) {
            const fileLabel = document.getElementById('fileLabel');
            if (input.files.length > 0) {
                fileLabel.textContent = '‚úÖ ' + input.files[0].name;
            } else {
                fileLabel.textContent = 'Nenhum arquivo selecionado';
            }
        }

	        function cleanNumber(value) {
	            if (typeof value !== 'string') {
	                value = String(value);
	            }
	            return value.replace(/[^0-9]/g, '');
	        }
	        let ncmList = []; // NCMs v√°lidos (4 ou 8 d√≠gitos, √∫nicos)
	        let ncmListInconsistent = []; // NCMs com n√∫mero de d√≠gitos diferente de 4 ou 8
	        let ncmListRepeated = []; // NCMs repetidos (duplicados)
	        let ncmSet = new Set(); // Para rastrear NCMs √∫nicos
	        let currentSkin = 'skin-1';
	
	        function updateSkinIndicator() {
	            const indicator = document.getElementById('currentSkinIndicator');
	            const activeBtn = document.querySelector(`.skin-btn.${currentSkin}-btn`);
	            if (indicator && activeBtn) {
	                indicator.style.background = activeBtn.style.background;
	            }
	        }
	
	        function toggleSkinDropdown() {
	            document.getElementById('skinDropdown').classList.toggle('show');
	        }
	
        function changeSkin(skin, event) {
            document.body.className = skin;
            currentSkin = skin;
            document.querySelectorAll('.skin-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateSkinIndicator();
            // Fechar o dropdown ap√≥s selecionar
            document.getElementById('skinDropdown').classList.remove('show');
        }
	
	        // Inicializa o indicador de skin
	        document.addEventListener('DOMContentLoaded', () => {
	            document.querySelector('.skin-btn.skin-1-btn').classList.add('active');
	            updateSkinIndicator();
	        });

	        function toggleCard(header) {
	            const content = header.nextElementSibling;
	            const btn = header.querySelector('.toggle-btn');
	            
	            // Verifica se o card-content tem display: none inline (como os novos quadros)
	            if (content.style.display === 'none') {
	                content.style.display = 'block';
	                btn.textContent = '‚àí';
	            } else if (content.style.display === 'block') {
	                content.style.display = 'none';
	                btn.textContent = '+';
	            } else {
	                // L√≥gica original para cards sem display: none inline
	                content.classList.toggle('active');
	                btn.textContent = content.classList.contains('active') ? '‚àí' : '+';
	            }
	        }

        function toggleDataSection(header) {
            const content = header.nextElementSibling;
            const btn = header.querySelector('.toggle-btn');
            if (content) {
                content.style.display = content.style.display === 'none' ? 'block' : 'none';
                btn.textContent = content.style.display === 'block' ? '‚àí' : '+';
            }
        }

        function addNcm() {
            const codigoNcm = document.getElementById('codigoNcm').value.trim();
            const codigoCest = document.getElementById('codigoCest').value.trim();

            if (!codigoNcm) {
                alert('Por favor, informe o C√≥digo NCM');
                return;
            }

            ncmList.push({ ncm: codigoNcm, cest: codigoCest });
            renderNcmList();
            document.getElementById('codigoNcm').value = '';
            document.getElementById('codigoCest').value = '';
        }

	        function renderNcmList() {
	            const ncmListDiv = document.getElementById('ncmList');
	            const inconsistentListDiv = document.getElementById('inconsistentNcmList');
	            const repeatedListDiv = document.getElementById('repeatedNcmList');
	            
	            ncmListDiv.innerHTML = '';
	            inconsistentListDiv.innerHTML = '';
	            repeatedListDiv.innerHTML = '';
	
	            document.getElementById('inconsistentCount').textContent = ncmListInconsistent.length;
	            document.getElementById('repeatedCount').textContent = ncmListRepeated.length;
	
	            // Renderizar NCMs V√°lidos
	            if (ncmList.length === 0) {
	                ncmListDiv.innerHTML = '<p style="color: rgba(255, 255, 255, 0.7);">Nenhum NCM v√°lido adicionado.</p>';
	            } else {
	                ncmList.forEach((ncm, index) => {
	                    const div = document.createElement('div');
	                    div.className = 'ncm-item';
	                    div.innerHTML = `
	                        <div class="ncm-item-content">
	                            <strong>NCM:</strong> ${ncm.ncm} | <strong>CEST:</strong> ${ncm.cest || '-'}
	                        </div>
	                        <div style="display: flex; gap: 5px;">
	                            <button class="ncm-item-btn" style="background: #2196F3;" onclick="editNcm(${index})">Editar</button>
	                            <button class="ncm-item-btn" onclick="removeNcm(${index})">Remover</button>
	                        </div>
	                    `;
	                    ncmListDiv.appendChild(div);
	                });
	            }
	
	            // Renderizar NCMs Inconsistentes
	            if (ncmListInconsistent.length === 0) {
	                inconsistentListDiv.innerHTML = '<p style="color: rgba(255, 255, 255, 0.7);">Nenhum NCM inconsistente.</p>';
	            } else {
	                ncmListInconsistent.forEach(ncm => {
	                    const div = document.createElement('div');
	                    div.className = 'ncm-item';
	                    div.style.borderLeft = '3px solid #f44336'; // Vermelho para inconsistente
	                    div.innerHTML = `
	                        <div class="ncm-item-content">
	                            <strong>NCM:</strong> ${ncm.ncm} | <strong>CEST:</strong> ${ncm.cest || '-'}
	                        </div>
	                    `;
	                    inconsistentListDiv.appendChild(div);
	                });
	            }
	
	            // Renderizar NCMs Repetidos
	            if (ncmListRepeated.length === 0) {
	                repeatedListDiv.innerHTML = '<p style="color: rgba(255, 255, 255, 0.7);">Nenhum NCM repetido.</p>';
	            } else {
	                ncmListRepeated.forEach(ncm => {
	                    const div = document.createElement('div');
	                    div.className = 'ncm-item';
	                    div.style.borderLeft = '3px solid #ff9800'; // Laranja para repetido
	                    div.innerHTML = `
	                        <div class="ncm-item-content">
	                            <strong>NCM:</strong> ${ncm.ncm} | <strong>CEST:</strong> ${ncm.cest || '-'}
	                        </div>
	                    `;
	                    repeatedListDiv.appendChild(div);
	                });
	            }
	        }

        function removeNcm(index) {
            ncmList.splice(index, 1);
            renderNcmList();
        }

        function editNcm(index) {
            const ncm = ncmList[index];
            document.getElementById('codigoNcm').value = ncm.ncm;
            document.getElementById('codigoCest').value = ncm.cest;
            ncmList.splice(index, 1);
            renderNcmList();
        }

        function addNewData() {
            const dataInicial = document.getElementById('dataInicial').value;
            const descricaoInicial = document.getElementById('descricaoInicial').value.trim();
            const descricaoTributacao = document.getElementById('descricaoTributacao').value.trim();

            if (!dataInicial || !descricaoInicial || !descricaoTributacao) {
                alert('Por favor, preencha Dados Iniciais e Tributa√ß√£o');
                return;
            }

            if (ncmList.length === 0) {
                alert('Por favor, adicione pelo menos um NCM');
                return;
            }

            const newData = {
                id: Date.now(),
                dataInicial: formatDate(dataInicial),
                descricaoInicial: descricaoInicial,
                descricaoTributacao: descricaoTributacao,
                tipoTributacao: document.getElementById('tipoTributacao').value,
                cstPisCofinEntrada: document.getElementById('cstPisCofinEntrada').value,
                vinculoCredito: document.getElementById('vinculoCredito').value,
                baseCredito: document.getElementById('baseCredito').value,
                aliquotaPisEntrada: document.getElementById('aliquotaPisEntrada').value,
                aliquotaCofinsEntrada: document.getElementById('aliquotaCofinsEntrada').value,
                cstPisCofinSaida: document.getElementById('cstPisCofinSaida').value,
                naturezaReceita: document.getElementById('naturezaReceita').value,
                aliquotaPisSaida: document.getElementById('aliquotaPisSaida').value,
                aliquotaCofinssSaida: document.getElementById('aliquotaCofinssSaida').value,
                cstIcmsEntrada: document.getElementById('cstIcmsEntrada').value,
                cstIcmsSaida: document.getElementById('cstIcmsSaida').value,
                aliquotaIcms: document.getElementById('aliquotaIcms').value,
                cstIpiEntrada: document.getElementById('cstIpiEntrada').value,
                cstIpiSaida: document.getElementById('cstIpiSaida').value,
                aliquotaIpi: document.getElementById('aliquotaIpi').value,
                produtoSujeitoPisCofins: document.getElementById('produtoSujeitoPisCofins').value,
                tipoTributacaoPisCofins: document.getElementById('tipoTributacaoPisCofins').value,
                ncmList: [...ncmList]
            };

	            lastDataInicial = dataInicial; // Armazena a data inicial
	            allData.push(newData);
	            renderDataList();
	            
	            // L√≥gica para travar a descri√ß√£o inicial
	            if (!initialDescriptionLocked) {
	                document.getElementById('descricaoInicial').setAttribute('readonly', true);
	                document.getElementById('descricaoInicial').style.background = 'rgba(255, 255, 255, 0.02)';
	                document.getElementById('descricaoInicial').style.cursor = 'not-allowed';
	                initialDescriptionLocked = true;
	            }
	            
	            resetForm();
	            ncmList = [];
	            renderNcmList();
	        }

        function copyPreviousDate() {
            if (lastDataInicial) {
                document.getElementById('dataInicial').value = lastDataInicial;
            } else {
                alert('Nenhuma data anterior para copiar.');
            }
        }

        function formatDate(dateString) {
            // Divide a data no formato YYYY-MM-DD
            const parts = dateString.split('-');
            if (parts.length === 3) {
                const year = parts[0];
                const month = parts[1];
                const day = parts[2];
                return `${day}/${month}/${year}`;
            }
            // Fallback para o m√©todo antigo se o formato for diferente
            const date = new Date(dateString);
            const dayNum = String(date.getDate()).padStart(2, '0');
            const monthNum = String(date.getMonth() + 1).padStart(2, '0');
            const yearNum = date.getFullYear();
            return `${dayNum}/${monthNum}/${yearNum}`;
        }

        function renderDataList() {
            const dataList = document.getElementById('dataList');
            dataList.innerHTML = '';
            allData.forEach((data, index) => {
                const div = document.createElement('div');
                div.className = 'data-item';
                div.innerHTML = `
                    <div class="data-item-header">
                        <div class="data-item-title">
                            ${data.descricaoTributacao} - ${data.dataInicial}
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="data-item-btn" style="background: #2196F3;" onclick="editData(${index})">Editar</button>
                            <button class="data-item-btn" onclick="removeData(${index})">Remover</button>
                        </div>
                    </div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.7);">
                        <strong>Descri√ß√£o:</strong> ${data.descricaoInicial}<br>
                        <strong>NCMs:</strong> ${data.ncmList.map(n => n.ncm).join(', ')}
                    </div>
                `;
                dataList.appendChild(div);
            });
        }

        function removeData(index) {
            allData.splice(index, 1);
            renderDataList();
        }

        function editData(index) {
            const data = allData[index];
            document.getElementById('dataInicial').value = data.dataInicial.split('/').reverse().join('-');
            document.getElementById('descricaoInicial').value = data.descricaoInicial;
            document.getElementById('descricaoTributacao').value = data.descricaoTributacao;
            document.getElementById('tipoTributacao').value = data.tipoTributacao;
            document.getElementById('cstPisCofinEntrada').value = data.cstPisCofinEntrada;
            document.getElementById('vinculoCredito').value = data.vinculoCredito;
            document.getElementById('baseCredito').value = data.baseCredito;
            document.getElementById('aliquotaPisEntrada').value = data.aliquotaPisEntrada;
            document.getElementById('aliquotaCofinsEntrada').value = data.aliquotaCofinsEntrada;
            document.getElementById('cstPisCofinSaida').value = data.cstPisCofinSaida;
            document.getElementById('naturezaReceita').value = data.naturezaReceita;
            document.getElementById('aliquotaPisSaida').value = data.aliquotaPisSaida;
            document.getElementById('aliquotaCofinssSaida').value = data.aliquotaCofinssSaida;
            document.getElementById('cstIcmsEntrada').value = data.cstIcmsEntrada;
            document.getElementById('cstIcmsSaida').value = data.cstIcmsSaida;
            document.getElementById('aliquotaIcms').value = data.aliquotaIcms;
            document.getElementById('cstIpiEntrada').value = data.cstIpiEntrada;
            document.getElementById('cstIpiSaida').value = data.cstIpiSaida;
            document.getElementById('aliquotaIpi').value = data.aliquotaIpi;
            document.getElementById('produtoSujeitoPisCofins').value = data.produtoSujeitoPisCofins;
            document.getElementById('tipoTributacaoPisCofins').value = data.tipoTributacaoPisCofins;
            ncmList = [...data.ncmList];
            renderNcmList();
            allData.splice(index, 1);
            renderDataList();
            document.querySelector('.content').scrollIntoView({ behavior: 'smooth' });
        }

	        function resetForm() {
	            document.getElementById('dataInicial').value = '';
	            // Mant√©m o valor da descri√ß√£o inicial se j√° estiver travado
	            if (!initialDescriptionLocked) {
	                document.getElementById('descricaoInicial').value = '';
	            }
	            document.getElementById('descricaoTributacao').value = '';
            document.getElementById('tipoTributacao').value = '';
            document.getElementById('cstPisCofinEntrada').value = '';
            document.getElementById('vinculoCredito').value = '';
            document.getElementById('baseCredito').value = '';
            document.getElementById('aliquotaPisEntrada').value = '';
            document.getElementById('aliquotaCofinsEntrada').value = '';
            document.getElementById('cstPisCofinSaida').value = '';
            document.getElementById('naturezaReceita').value = '';
            document.getElementById('aliquotaPisSaida').value = '';
            document.getElementById('aliquotaCofinssSaida').value = '';
            document.getElementById('cstIcmsEntrada').value = '';
            document.getElementById('cstIcmsSaida').value = '';
            document.getElementById('aliquotaIcms').value = '';
            document.getElementById('cstIpiEntrada').value = '';
            document.getElementById('cstIpiSaida').value = '';
            document.getElementById('aliquotaIpi').value = '';
            document.getElementById('produtoSujeitoPisCofins').value = '';
            document.getElementById('tipoTributacaoPisCofins').value = '';
        }

	        function generateFile() {
	            if (allData.length === 0) {
	                alert('Nenhum dado para gerar');
	                return;
	            }
	
		            showSpinner('Gerando arquivo TXT...');
		            let content = '';
		
	            allData.forEach((data, index) => {
	                if (index === 0) {
	                    // Cabe√ßalho e Vig√™ncia apenas no primeiro registro
	                    content += 'Tipo;Data;Descri√ß√£o;;;;;;;;;;;;;;;;\n';
	                    content += `Vigencia;${data.dataInicial};${data.descricaoInicial};;;;;;;;;;;;;;;;\n`;
	                }
	                
	                content += 'Tipo;Descri√ß√£o;;;;;;;;;;;;;;;;;\n';
                content += `Item;${data.descricaoTributacao};;;;;;;;;;;;;;;;;\n`;
                content += 'Tipo;Tipo Tributa√ß√£o (N-N√£o cumulativo/C-Cumulativo/T-Subt. Tribut√°ria/S-Sem incid√™ncia);CST PIS/COFINS Entrada;Vinculo do Cr√©dito;Base de Cr√©dito;Al√≠quota PIS Entrada;Al√≠quota Cofins Entrada;CST PIS/COFINS Sa√≠da;Natureza Receita;Al√≠quota PIS Sa√≠da;Al√≠quota Cofins Sa√≠da;CST ICMS Entrada;CST ICMS Sa√≠da;Al√≠quota ICMS;CST IPI Entrada;CST IPI Sa√≠da;Al√≠quota IPI;Produto sujeito a PIS/COFINS? S/N;Tipo de Tributa√ß√£o do PIS/COFINS (1-Monof√°sico / 2-Subst. Tribut√°ria)\n';
                content += `Impostos;${data.tipoTributacao};${data.cstPisCofinEntrada};${data.vinculoCredito};${data.baseCredito};${data.aliquotaPisEntrada};${data.aliquotaCofinsEntrada};${data.cstPisCofinSaida};${data.naturezaReceita};${data.aliquotaPisSaida};${data.aliquotaCofinssSaida};${data.cstIcmsEntrada};${data.cstIcmsSaida};${data.aliquotaIcms};${data.cstIpiEntrada};${data.cstIpiSaida};${data.aliquotaIpi};${data.produtoSujeitoPisCofins};${data.tipoTributacaoPisCofins}\n`;
                content += 'Tipo;C√≥digo NCM;C√≥digo CEST;;;;;;;;;;;;;;;;\n';
                data.ncmList.forEach(ncm => {
                    const cleanedNcm = cleanNumber(ncm.ncm);
                    const cleanedCest = cleanNumber(ncm.cest);
                    content += `NCM;${cleanedNcm};${cleanedCest ? cleanedCest : ''};;;;;;;;;;;;;;;;;\n`;
                });
            });

            // Remove a √∫ltima quebra de linha para evitar um registro vazio no final
            if (content.endsWith('\n')) {
                content = content.slice(0, -1);
            }

            downloadFile(content, 'dados_tributacao.txt');
	            hideSpinner();
	        }

	        function downloadFile(content, filename) {
	            // Cria um Blob com o conte√∫do e a codifica√ß√£o ISO-8859-1 (compat√≠vel com ANSI)
	            const blob = new Blob([content], { type: 'text/plain;charset=ISO-8859-1' });
	            const url = URL.createObjectURL(blob);
	
	            const element = document.createElement('a');
	            element.setAttribute('href', url);
	            element.setAttribute('download', filename);
	            element.style.display = 'none';
	            document.body.appendChild(element);
	            element.click();
	            document.body.removeChild(element);
	
	            // Libera o objeto URL
	            URL.revokeObjectURL(url);
	        }

		        function importFile() {
		            const fileInput = document.getElementById('fileImport');
		            if (!fileInput.files.length) {
		                alert('Por favor, selecione um arquivo');
		                return;
		            }
		
		            showSpinner('Lendo arquivo Excel...');
		            const file = fileInput.files[0];
		            const reader = new FileReader();
		
		            reader.onload = function(e) {
		                // showSpinner('Processando arquivo...'); // J√° est√° no showSpinner
		                const data = new Uint8Array(e.target.result);
	                const workbook = XLSX.read(data, { type: 'array' });
	
	                // Assumindo que a primeira aba √© a que cont√©m os dados
	                const firstSheetName = workbook.SheetNames[0];
	                const worksheet = workbook.Sheets[firstSheetName];
	
	                // Converter a planilha para um array de objetos (JSON)
	                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
	
	                if (json.length === 0) {
	                    hideSpinner();
	                    alert('O arquivo Excel est√° vazio.');
	                    return;
	                }
	
	                // A primeira linha √© o cabe√ßalho
	                const headers = json[0];
	                const dataRows = json.slice(1);
	
	                // Limpar dados anteriores
	                excelHeaders = {};
	                excelData = {};
	
	                // Processar cabe√ßalhos e dados
	                headers.forEach((header, index) => {
	                    const colKey = `col${index + 1}`;
	                    excelHeaders[colKey] = header;
	                    excelData[colKey] = dataRows.map(row => row[index] !== undefined ? String(row[index]) : '');
	                });
	
	                hideSpinner();
	                openMappingModal();
	            };
	
	            reader.onerror = function(ex) {
	                hideSpinner();
	                alert('Erro ao ler o arquivo: ' + ex);
	            };
	
	            reader.readAsArrayBuffer(file);
	        }



        function showSpinner(message = 'Carregando...') {
            document.getElementById('spinnerText').textContent = message;
            document.getElementById('spinnerOverlay').classList.add('active');
        }

        function hideSpinner() {
            document.getElementById('spinnerOverlay').classList.remove('active');
        }



	        let excelHeaders = {};
	        let excelData = {};

        function openMappingModal() {
            // Preencher os selects com os cabe√ßalhos
            const ncmSelect = document.getElementById('ncmColumnSelect');
            const cestSelect = document.getElementById('cestColumnSelect');
            
            // Limpar as op√ß√µes existentes mantendo apenas a primeira
            while (ncmSelect.options.length > 1) {
                ncmSelect.remove(1);
            }
            while (cestSelect.options.length > 1) {
                cestSelect.remove(1);
            }
            
            Object.keys(excelHeaders).forEach(colKey => {
                const option1 = document.createElement('option');
                option1.value = colKey;
                option1.textContent = excelHeaders[colKey];
                ncmSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = colKey;
                option2.textContent = excelHeaders[colKey];
                cestSelect.appendChild(option2);
            });

            document.getElementById('mappingModal').classList.add('active');
        }

        function closeMappingModal() {
            document.getElementById('mappingModal').classList.remove('active');
        }

        function applyMapping() {
            const ncmColumn = document.getElementById('ncmColumnSelect').value;
            const cestColumn = document.getElementById('cestColumnSelect').value;

            if (!ncmColumn) {
                alert('Por favor, selecione a coluna para NCM');
                return;
            }

            const ncmValues = excelData[ncmColumn] || [];
            const cestValues = cestColumn ? (excelData[cestColumn] || []) : [];

            // Validar se h√° dados para importar
            if (ncmValues.length === 0) {
                alert('Nenhum dado encontrado na coluna selecionada');
                return;
            }

	            // Limpar listas anteriores
	            ncmList = [];
	            ncmListInconsistent = [];
	            ncmListRepeated = [];
	            ncmSet = new Set();
	
	            let totalImported = 0;
	
	            // Processar os NCMs importados
	            ncmValues.forEach((ncm, index) => {
	                const originalNcm = ncm ? ncm.trim() : '';
	                const originalCest = (cestValues[index] || '').trim();
	                
	                if (originalNcm === '') return;
	
	                totalImported++;
	                const cleanedNcm = cleanNumber(originalNcm);
	                const ncmLength = cleanedNcm.length;
	
	                const ncmData = {
	                    ncm: originalNcm,
	                    cest: originalCest
	                };
	
	                // 1. Filtrar Inconsistentes (diferente de 4 ou 8 d√≠gitos)
	                if (ncmLength !== 4 && ncmLength !== 8) {
	                    ncmListInconsistent.push(ncmData);
	                    return;
	                }
	
	                // 2. Tratar Repeti√ß√£o (prioridade para o mais espec√≠fico)
	                // O NCM de 8 d√≠gitos √© mais espec√≠fico. Se o NCM de 4 d√≠gitos for um prefixo de um NCM de 8 d√≠gitos j√° visto, o de 4 √© repetido.
	                // Se o NCM de 8 d√≠gitos for visto e o de 4 d√≠gitos for o prefixo, o de 4 √© ignorado (n√£o adicionado ao set).
	                
	                // Verifica se o NCM j√° foi visto
	                if (ncmSet.has(cleanedNcm)) {
	                    ncmListRepeated.push(ncmData);
	                    return;
	                }
	
	                // Verifica se o NCM de 4 d√≠gitos √© prefixo de um NCM de 8 d√≠gitos j√° visto
	                if (ncmLength === 4) {
	                    let isPrefixOfEightDigit = false;
	                    for (const existingNcm of ncmSet) {
	                        if (existingNcm.length === 8 && existingNcm.startsWith(cleanedNcm)) {
	                            isPrefixOfEightDigit = true;
	                            break;
	                        }
	                    }
	                    if (isPrefixOfEightDigit) {
	                        ncmListRepeated.push(ncmData);
	                        return;
	                    }
	                }
	
	                // Verifica se o NCM de 8 d√≠gitos tem um prefixo de 4 d√≠gitos j√° visto
	                if (ncmLength === 8) {
	                    const prefix4 = cleanedNcm.substring(0, 4);
	                    if (ncmSet.has(prefix4)) {
	                        // Se o prefixo de 4 d√≠gitos j√° foi visto, remove o de 4 e adiciona o de 8 (mais espec√≠fico)
	                        // Isso exige reprocessar a lista de v√°lidos, o que √© complexo.
	                        // A abordagem mais simples √© considerar o de 8 como repetido, conforme a regra confusa do usu√°rio.
	                        // No entanto, a regra mais l√≥gica √© a substitui√ß√£o.
	                        
	                        // Implementando a l√≥gica de substitui√ß√£o (mais correta):
	                        // 1. Encontra o NCM de 4 d√≠gitos na lista de v√°lidos
	                        const index4 = ncmList.findIndex(item => cleanNumber(item.ncm) === prefix4);
	                        if (index4 !== -1) {
	                            // Remove o NCM de 4 d√≠gitos e o adiciona √† lista de repetidos (ou inconsistentes, se for o caso)
	                            const removedNcm = ncmList.splice(index4, 1)[0];
	                            ncmSet.delete(prefix4);
	                            ncmListRepeated.push(removedNcm); // O de 4 √© repetido/substitu√≠do
	                        }
	                    }
	                }
	
	                // Adiciona o NCM √† lista de v√°lidos
	                ncmSet.add(cleanedNcm);
	                ncmList.push(ncmData);
	            });
	
	            // O usu√°rio pediu: "se houver NCM de 4 digitos e um de 8 com os mesmos do de 4 digitos, ele deve enviar o de 8 para um novo quadro de NCM/CEST repetidos"
	            // Isso √© o oposto da l√≥gica de substitui√ß√£o. Vou implementar a l√≥gica de repeti√ß√£o estrita (apenas o primeiro √© v√°lido).
	            
	            // Refazendo a l√≥gica de repeti√ß√£o estrita:
	            ncmList = [];
	            ncmListInconsistent = [];
	            ncmListRepeated = [];
	            ncmSet = new Set();
	
	            ncmValues.forEach((ncm, index) => {
	                const originalNcm = ncm ? ncm.trim() : '';
	                const originalCest = (cestValues[index] || '').trim();
	                
	                if (originalNcm === '') return;
	
	                const cleanedNcm = cleanNumber(originalNcm);
	                const ncmLength = cleanedNcm.length;
	
	                const ncmData = {
	                    ncm: originalNcm,
	                    cest: originalCest
	                };
	
	                // 1. Filtrar Inconsistentes (diferente de 4 ou 8 d√≠gitos)
	                if (ncmLength !== 4 && ncmLength !== 8) {
	                    ncmListInconsistent.push(ncmData);
	                    return;
	                }
	
	                // 2. Tratar Repeti√ß√£o (apenas o primeiro NCM √© v√°lido)
	                if (ncmSet.has(cleanedNcm)) {
	                    ncmListRepeated.push(ncmData);
	                    return;
	                }
	
	                // 3. Tratar prefixo/full match (aqui est√° a confus√£o do usu√°rio)
	                // Se o NCM de 4 d√≠gitos for prefixo de um NCM de 8 d√≠gitos j√° visto, o de 4 √© repetido.
	                // Se o NCM de 8 d√≠gitos for visto e o de 4 d√≠gitos for o prefixo, o de 4 √© ignorado (n√£o adicionado ao set).
	                
	                let isRepeatedByPrefix = false;
	                
	                if (ncmLength === 4) {
	                    // Verifica se o NCM de 4 d√≠gitos √© prefixo de um NCM de 8 d√≠gitos j√° visto
	                    for (const existingNcm of ncmSet) {
	                        if (existingNcm.length === 8 && existingNcm.startsWith(cleanedNcm)) {
	                            isRepeatedByPrefix = true;
	                            break;
	                        }
	                    }
	                } else if (ncmLength === 8) {
	                    // Verifica se o NCM de 8 d√≠gitos tem um prefixo de 4 d√≠gitos j√° visto
	                    const prefix4 = cleanedNcm.substring(0, 4);
	                    if (ncmSet.has(prefix4)) {
	                        // O NCM de 4 d√≠gitos j√° foi visto. O usu√°rio quer que o de 8 seja o repetido.
	                        // Isso √© o oposto da l√≥gica de substitui√ß√£o (onde o de 4 seria substitu√≠do pelo de 8).
	                        // Vou seguir a regra literal do usu√°rio: enviar o de 8 para repetidos.
	                        isRepeatedByPrefix = true;
	                    }
	                }
	
	                if (isRepeatedByPrefix) {
	                    ncmListRepeated.push(ncmData);
	                    return;
	                }
	
	                // 4. Adiciona o NCM √† lista de v√°lidos
	                ncmSet.add(cleanedNcm);
	                ncmList.push(ncmData);
	            });
	
	            const importedCount = ncmList.length;
	            renderNcmList();
	            closeMappingModal();
	            
	            if (totalImported > 0) {
	                alert(`Processamento conclu√≠do:\n\n- V√°lidos: ${ncmList.length}\n- Inconsistentes: ${ncmListInconsistent.length}\n- Repetidos: ${ncmListRepeated.length}`);
	            } else {
	                alert('Nenhum NCM v√°lido foi importado');
	            }
        }

        // Fechar modal ao clicar fora dele
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('mappingModal');
            if (event.target === modal) {
                closeMappingModal();
            }
        });

        // Initialize
        document.querySelectorAll('.skin-btn')[0].classList.add('active');
    </script>


    <!-- Modal de Mapeamento de Colunas -->
    <div id="mappingModal" class="mapping-modal">
        <div class="mapping-modal-content">
            <div class="mapping-modal-title">Mapeamento de Colunas do Excel</div>
            <p style="margin-bottom: 20px; font-size: 14px; color: rgba(255,255,255,0.7);">
                Selecione qual coluna do arquivo Excel corresponde a cada campo:
            </p>

            <div class="mapping-item">
                <div class="mapping-item-label">Coluna para NCM:</div>
                <select id="ncmColumnSelect">
                    <option value="">Selecione a coluna...</option>
                </select>
            </div>
            <div class="mapping-item">
                <div class="mapping-item-label">Coluna para CEST:</div>
                <select id="cestColumnSelect">
                    <option value="">Selecione a coluna...</option>
                </select>
            </div>
            <div class="mapping-buttons">
                <button class="btn btn-success" onclick="applyMapping()">Aplicar Mapeamento</button>
                <button class="btn btn-primary" onclick="closeMappingModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Spinner de Carregamento -->
    <div id="spinnerOverlay" class="spinner-overlay">
        <div class="spinner-container">
            <div class="spinner"></div>
            <div class="spinner-text" id="spinnerText">Carregando...</div>
            <div class="spinner-progress">
                <div class="spinner-progress-bar"></div>
            </div>
        </div>
    </div>

    <!-- Spinner com Glass Effect -->
    <div class="spinner-overlay" id="spinnerOverlay">
        <div class="spinner-container">
            <div class="spinner"></div>
            <div class="spinner-text" id="spinnerText">Carregando...</div>
            <!-- <div class="spinner-progress">
                <div class="spinner-progress-bar"></div>
            </div> -->
        </div>
    </div>

    </body>
</html>
